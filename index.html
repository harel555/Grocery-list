<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רשימת הקניות שלי</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f9e3a9;
            color: #00008B;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            direction: rtl;
            text-align: right;
        }
        .container {
            max-width: 1000px; /* רוחב מספק ל-2 עמודות */
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        td {
            width: 50%; /* 2 עמודות */
            vertical-align: top;
            padding: 8px;
            box-sizing: border-box;
        }
        .product-item {
            background-color: #e9e9e9;
            margin-bottom: 8px;
            padding: 5px 10px; /* פאדינג מופחת */
            border-radius: 5px;
            display: flex; /* פלקסבוקס לשורה אחת בתוך התא */
            align-items: center;
            justify-content: space-between;
            font-size: 0.95em;
            transition: background-color 0.2s ease, border-right 0.2s ease;
            min-height: 50px; /* גובה מינימלי סביר לפריט שכולל מספר אלמנטים בשורה */
        }
        .product-item:hover {
            background-color: #dcdcdc;
        }
        /* קלאס לפריט שנבחר לעגלה (ירוק בצד) */
        .product-item.selected-for-purchase {
            background-color: #d4edda; /* ירוק בהיר יותר לבחירה */
            border-right: 5px solid #28a745; /* פס ירוק ליד פריטים נבחרים */
        }
        /* קלאס לפריט שסומן כנקנה (קו חוצה ואפור) - רק במצב רשימת קניות */
        .shopping-list-mode .product-item.purchased {
            text-decoration: line-through;
            color: #888;
            background-color: #f0f0f0;
            border-right: none; /* בטל את הפס הירוק אם סומן כנקנה */
        }

        /* סעיף הוספת פריט חדש - עיצוב */
        .add-new-item-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .add-new-item-section label {
            font-weight: bold;
            color: #34495e;
        }
        .add-new-item-section input[type="text"],
        .add-new-item-section input[type="number"],
        .add-new-item-section select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }
        .add-new-item-section button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: auto;
            align-self: flex-end;
        }
        .add-new-item-section button:hover {
            background-color: #0056b3;
        }

        /* פריטי רשימה - אלמנטים בתוך ה-TD */
        .item-name {
            font-weight: bold;
            flex-shrink: 0;
            margin-left: 10px;
            color: #00008B;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            flex-grow: 1; /* מאפשר לזה לתפוס את רוב המקום */
            justify-content: flex-start;
            gap: 5px;
            flex-wrap: wrap; /* יאפשר גלישה בשורות קטנות */
        }
        .quantity-control input[type="radio"] {
            margin: 0 2px;
            flex-shrink: 0;
        }
        .quantity-control label {
            font-size: 0.85em;
            color: #555;
            flex-shrink: 0;
        }
        .quantity-control input[type="number"] {
            width: 50px; /* רוחב קטן יותר לשדה מספר */
            padding: 3px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            font-size: 0.8em;
            -moz-appearance: textfield;
            appearance: textfield;
            margin-right: 5px; /* רווח מימין למספר */
        }
        /* הסתרת כפתורי החצים בשדה מספר */
        .quantity-control input[type="number"]::-webkit-outer-spin-button,
        .quantity-control input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* כפתור וי שיוצג רק במצב רשימת קניות */
        .item-actions .purchased-toggle-btn {
            color: #28a745;
            display: none; /* מוסתר כברירת מחדל */
        }
        .shopping-list-mode .item-actions .purchased-toggle-btn {
            display: inline-block; /* מוצג במצב רשימת קניות */
        }
        /* כפתור עגלה יוסתר במצב רשימת קניות */
        .shopping-list-mode .item-actions .select-btn {
            display: none; 
        }
        /* במצב רשימת קניות, הסתר את בקרות הכמות והצג את התצוגה הסטטית */
        .shopping-list-mode .quantity-control {
            display: none !important;
        }
        .shopping-list-mode .quantity-display {
            display: inline-block !important; /* הצג כמות סטטית */
            font-weight: bold;
            color: #333;
            margin-left: 10px;
        }

        /* כפתורי שליטה ראשיים למעלה ולמטה */
        .main-controls {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap; /* יאפשר גלישה בשורות קטנות */
        }
        .main-controls button {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        .main-controls button:hover {
            background-color: #5a6268;
        }
        #show-all-btn.active-mode {
            background-color: #007bff;
        }
        #show-all-btn:hover {
            background-color: #0056b3;
        }
        #show-shopping-list-btn.active-mode {
            background-color: #28a745;
        }
        #show-shopping-list-btn:hover {
            background-color: #218838;
        }
        /* כפתור וואטסאפ */
        .whatsapp-button {
            background-color: #25D366; /* WhatsApp green */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            margin-bottom: 20px; /* רווח מתחת לכפתור */
            margin-top: 10px; /* רווח מעל לכפתור */
        }
        .whatsapp-button:hover {
            background-color: #1DA851;
        }
        .whatsapp-settings {
            margin-top: 15px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .whatsapp-settings label {
            font-weight: bold;
            color: #34495e;
        }
        .whatsapp-settings input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }


        /* הסתרת קטגוריות כשהן ריקות במצב תצוגת קניות */
        .category-hidden {
            display: none !important;
        }

        /* Responsive design for mobile (single column) */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* פאדינג קטן יותר בטלפון */
            }
            .container {
                padding: 15px;
                margin: 10px auto; /* מרווח קטן יותר מהקצוות */
            }
            td {
                width: 100%; /* תא אחד ברוחב מלא */
                display: block; /* וודא שהתא תופס שורה שלמה */
                padding: 5px 0; /* פאדינג מופחת בצדדים */
            }
            .product-item {
                flex-direction: column; /* הפוך לעמודה אחת בתוך הפריט */
                align-items: flex-end; /* יישור לימין */
                padding: 10px;
                min-height: auto;
                text-align: right; /* וודא יישור טקסט לימין */
            }
            .item-name {
                width: 100%;
                margin-left: 0;
                margin-bottom: 5px;
                text-align: right;
            }
            .quantity-control {
                width: 100%;
                justify-content: flex-end;
                margin-bottom: 10px;
                text-align: right;
            }
            .item-actions {
                width: 100%;
                justify-content: flex-end;
            }
            .add-new-item-section button {
                width: 100%;
                align-self: center;
            }
            .main-controls {
                flex-direction: column;
                gap: 10px;
            }
            .main-controls button {
                width: 100%;
            }
            /* כפתור הוואטסאפ גם יהיה ברוחב מלא */
            .whatsapp-button {
                width: 100%;
                box-sizing: border-box; /* כולל פאדינג ובורדר ברוחב */
            }
            .whatsapp-settings input[type="text"] {
                font-size: 1em; /* גופן קצת יותר גדול בשדות קלט בנייד */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🛒 רשימת הקניות שלי 🛒</h1>

        <div class="main-controls">
            <button id="show-shopping-list-btn">הצג רשימת קניות נוכחית</button>
            <button id="show-all-btn">הצג את כל המוצרים</button>
        </div>

        <div class="whatsapp-settings">
            <label for="whatsapp-numbers">מספרי טלפון לשליחה (מופרדים בפסיק):</label>
            <input type="text" id="whatsapp-numbers" value="0506245447,0506232259">
        </div>
        <button class="whatsapp-button" onclick="exportToWhatsApp()">שלח רשימת קניות לווטסאפ</button>

        <div id="vegetables-div">
            <h2>ירקות</h2>
            <table id="vegetables-table"><tbody></tbody></table>
        </div>

        <div id="fruits-div">
            <h2>פירות</h2>
            <table id="fruits-table"><tbody></tbody></table>
        </div>

        <div id="dairy-products-div">
            <h2>מוצרי חלב</h2>
            <table id="dairy-products-table"><tbody></tbody></table>
        </div>

        <div id="meat-products-div">
            <h2>מוצרי בשר</h2>
            <table id="meat-products-table"><tbody></tbody></table>
        </div>

        <div id="fish-products-div">
            <h2>דגים</h2>
            <table id="fish-products-table"><tbody></tbody></table>
        </div>

        <div id="cleaning-items-div">
            <h2>מוצרי ניקיון</h2>
            <table id="cleaning-items-table"><tbody></tbody></table>
        </div>

        <div id="legumes-div">
            <h2>קטניות</h2>
            <table id="legumes-table"><tbody></tbody></table>
        </div>

        <div id="various-items-div">
            <h2>שונות</h2>
            <table id="various-items-table"><tbody></tbody></table>
        </div>


        <div class="add-new-item-section">
            <h2>הוסף פריט חדש</h2>
            <label for="new-item-text">שם הפריט:</label>
            <input type="text" id="new-item-text" placeholder="הכנס שם פריט">

            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="new-item-quantity-add">כמות:</label>
                <input type="number" id="new-item-quantity-add" value="0" min="0" step="0.1" max="99.9" onfocus="this.select()" style="width: 70px;">

                <span id="add-item-unit-controls">
                    <input type="radio" id="add-unit-type-kg" name="add-unit-type" value="kg" checked>
                    <label for="add-unit-type-kg">ק״ג</label>

                    <input type="radio" id="add-unit-type-units" name="add-unit-type" value="units">
                    <label for="add-unit-type-units">יחידות</label>
                </span>
            </div>

            <label for="category-select">שייך לקטגוריה:</label>
            <select id="category-select">
            </select>
            <button onclick="addNewItem()">הוסף פריט</button>
        </div>

        <div class="add-new-item-section">
            <h2>הוסף קטגוריה חדשה</h2>
            <label for="new-category-name">שם הקטגוריה החדשה:</label>
            <input type="text" id="new-category-name" placeholder="לדוגמא: 'שימורים'">
            <button onclick="addNewCategory()">הוסף קטגוריה</button>
        </div>

        <button class="whatsapp-button" onclick="exportToWhatsApp()">שלח רשימת קניות לווטסאפ</button>

    </div>

    <script>
        const STORAGE_KEY = 'shoppingListItemsV8'; // שינוי שם המפתח לגרסה חדשה
        let currentItems = {}; // מבנה נתונים שיכיל את כל הקטגוריות והמוצרים
        const categoryMap = {}; // מפה לקישור בין ID ה-UL לשם הקטגוריה המוצג

        // *******************************************************************
        // מפת כללים ליחידות לפי קטגוריה
        // *******************************************************************
        const categoryUnitRules = {
            "vegetables-table": { allowKg: true, allowUnits: true, defaultUnitType: "kg" },
            "fruits-table": { allowKg: true, allowUnits: true, defaultUnitType: "kg" },
            "dairy-products-table": { allowKg: true, allowUnits: true, defaultUnitType: "units" }, // ברירת מחדל למוצרי חלב
            "meat-products-table": { allowKg: true, allowUnits: false, defaultUnitType: "kg" },
            "fish-products-table": { allowKg: true, allowUnits: true, defaultUnitType: "kg" },
            "cleaning-items-table": { allowKg: false, allowUnits: true, defaultUnitType: "units" },
            "legumes-table": { allowKg: false, allowUnits: true, defaultUnitType: "units" },
            "various-items-table": { allowKg: false, allowUnits: true, defaultUnitType: "units" }
            // קטגוריות חדשות יקבלו ברירת מחדל או שצריך להוסיף אותן כאן
        };

        // הגדרה ראשונית של מוצרים (רק אם אין נתונים שמורים)
        const initialProductsData = {
            "vegetables-table": [
                { name: "מלפפונים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "עגבניות שרי", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "עגבניות", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "בצל", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "פלפל אדום", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "פלפל ירוק", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "פלפל צהוב", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "קישואים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "חצילים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "תפוחי אדמה", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "פטרוזיליה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "כוסברה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "שמיר", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "נענע", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "בצל ירוק", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "חסה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "חסה עגולה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "דלעת", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "דלורית", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false }
            ],
            "fruits-table": [
                { name: "בננה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "תפוזים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "תפוחים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "ענבים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "אפרסקים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "משמש", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "אבטיח", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "אבוקדו", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "תותים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "מלון", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "שסק", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "קיווי", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "דובדבנים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "סברס", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false }
            ],
            "dairy-products-table": [
                { name: "חלב דל לקטוז", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false }, // ספציפי: רק יחידות
                { name: "גבינה צהובה מגורדת", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "גבינת טל העמק פרוסה דק", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "מנצ׳גו גוש", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "גבינת שמנת", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "גבינה לבנה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "קוטג׳", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "יוגורט", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "שמנת לבישול", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "שמנת להקצפה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "חמאה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "שמנת חמוצה 9%", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "גבינת פטה פיראוס", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "גבינה צפתית", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false }
            ],
            "meat-products-table": [
                { name: "כתף 5", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "בשר לבישול ארוך", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "פרגיות", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "חזה עוף", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "כרעיים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "שוקיים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "ירכיים", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "בשר טחון", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "בשר מספר 8", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "בשר מספר 2", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "כבד", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false }
            ],
            "fish-products-table": [
                { name: "סלמון", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "פילה אמנון", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false },
                { name: "דג שלם", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "קרפיון שלם", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "קרפיון טחון", quantity: 0, unit: "ק״ג", unitType: "kg", selected: false, purchased: false }
            ],
            "cleaning-items-table": [
                { name: "רסס ונגב", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "רסס וכבס", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "אוקונומיקה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "נוזל כלים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "מסיר שומנים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "מסיר שומנים קר", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "חומר לחלונות", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "שמפו", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "סבון", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "מרכך", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "ספוג לכלים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "ספוג לסירים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "סמרטוטים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false }
            ],
            "legumes-table": [
                { name: "אורז", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "אורז יסמין", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "אורז פרסי", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "אורז בסמתי", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "עדשים ירוקות", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "עדשים כתומות", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "עדשים שחורות", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "חומוס", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "חומוס ענק", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false }
            ],
            "various-items-table": [
                { name: "ביצים", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "מיונז", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false },
                { name: "טחינה", quantity: 0, unit: "יחידות", unitType: "units", selected: false, purchased: false }
            ]
        };

        // פונקציה לשמירת המצב ל-localStorage
        function saveItems() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(currentItems));
        }

        // פונקציה לטעינת המצב מ-localStorage
        function loadItems() {
            const storedItems = localStorage.getItem(STORAGE_KEY);
            let loadedData;
            if (storedItems) {
                loadedData = JSON.parse(storedItems);
            } else {
                loadedData = {};
            }

            // עדכן את currentItems עם הנתונים השמורים, תוך כדי הבטחה שקטגוריות מוגדרות מראש קיימות
            for (const categoryId in initialProductsData) {
                if (!loadedData[categoryId]) {
                    loadedData[categoryId] = initialProductsData[categoryId];
                } else {
                    // מיזוג: נתונים שמורים עוקפים הגדרות ראשוניות, אבל אם חסרים - ניקח מהגדרות ראשוניות
                    loadedData[categoryId] = loadedData[categoryId].map(loadedItem => {
                        const initialItem = initialProductsData[categoryId]?.find(item => item.name === loadedItem.name);
                        return { ...initialItem, ...loadedItem }; // מיזוג אובייקטים
                    });
                    // הוסף פריטים חדשים מה-initialData שלא קיימים ב-loadedData
                    initialProductsData[categoryId].forEach(initialItem => {
                        if (!loadedData[categoryId].some(loadedItem => loadedItem.name === initialItem.name)) {
                            loadedData[categoryId].push(initialItem);
                        }
                    });
                }
            }

            // וודא שה-categoryMap מעודכן
            document.querySelectorAll('div[id$="-div"]').forEach(categoryDiv => {
                const tableId = categoryDiv.querySelector('table[id$="-table"]').id;
                const h2Text = categoryDiv.querySelector('h2').textContent;
                categoryMap[tableId] = h2Text;
            });
            // עבור קטגוריות שנוספו דינמית (לא ב-initialProductsData)
            for (const categoryId in loadedData) {
                if (!categoryMap[categoryId]) {
                    const categoryDiv = document.getElementById(categoryId.replace('-table', '-div'));
                    if (categoryDiv) {
                        const h2Text = categoryDiv.querySelector('h2').textContent;
                        categoryMap[categoryId] = h2Text;
                    }
                }
            }

            return loadedData;
        }

        // פונקציה לעדכון תצוגת הכמות הסטטית של פריט
        function updateQuantityDisplay(item, productItemDiv) {
            const quantityDisplaySpan = productItemDiv.querySelector('.quantity-display');
            if (quantityDisplaySpan) {
                // הצג רק אם יש כמות גדולה מ-0
                if (item.quantity > 0 && item.unit) {
                    quantityDisplaySpan.textContent = `${item.quantity} ${item.unit}`;
                } else {
                    quantityDisplaySpan.textContent = ''; // נקה אם אין כמות או יחידה
                }
            }
        }

        // פונקציה ליצירת אלמנט TD עבור פריט
        function createProductTdElement(item, categoryTableId) {
            const td = document.createElement('td');
            const productItemDiv = document.createElement('div');
            productItemDiv.className = 'product-item';
            productItemDiv.setAttribute('data-item', item.name);
            productItemDiv.setAttribute('data-category-table-id', categoryTableId);

            // הדגשה: קלאסים מבוססים על המאפיינים
            if (item.selected) {
                productItemDiv.classList.add('selected-for-purchase');
            }
            if (item.purchased) {
                productItemDiv.classList.add('purchased');
            }

            // שם המוצר
            const itemNameSpan = document.createElement('span');
            itemNameSpan.className = 'item-name';
            itemNameSpan.textContent = item.name;
            productItemDiv.appendChild(itemNameSpan);

            // בקרת כמות ויחידת מידה
            const quantityControlDiv = document.createElement('div');
            quantityControlDiv.className = 'quantity-control';

            // קבלת כללי היחידות עבור הקטגוריה
            const rules = categoryUnitRules[categoryTableId] || { allowKg: true, allowUnits: true, defaultUnitType: "units" }; // ברירת מחדל

            // טיפול מיוחד ב"חלב דל לקטוז" - רק יחידות
            const isMilk = item.name === "חלב דל לקטוז" && categoryTableId === "dairy-products-table";

            // כפתור רדיו "ק"ג"
            const radioKg = document.createElement('input');
            const uniqueIdKg = `radio-${categoryTableId}-${item.name}-kg-${Math.random().toString(36).substring(7)}`;
            radioKg.id = uniqueIdKg;
            radioKg.type = 'radio';
            radioKg.name = `unit-type-${categoryTableId}-${item.name}-${Math.random().toString(36).substring(7)}`;
            radioKg.value = 'kg';
            
            const labelKg = document.createElement('label');
            labelKg.htmlFor = radioKg.id;
            labelKg.textContent = 'ק״ג';

            // כפתור רדיו "יחידות"
            const radioUnits = document.createElement('input');
            const uniqueIdUnits = `radio-${categoryTableId}-${item.name}-units-${Math.random().toString(36).substring(7)}`;
            radioUnits.id = uniqueIdUnits;
            radioUnits.type = 'radio';
            radioUnits.name = radioKg.name; // השתמש באותו שם קבוצה
            radioUnits.value = 'units';
            
            const labelUnits = document.createElement('label');
            labelUnits.htmlFor = radioUnits.id;
            labelUnits.textContent = 'יחידות';

            // קביעת מצב ברירת המחדל של כפתורי הרדיו
            if (isMilk) { // חלב תמיד יחידות
                radioUnits.checked = true;
                item.unitType = 'units'; // וודא שנתוני הפריט מעודכנים
                item.unit = 'יחידות';
            } else if (item.unitType === 'kg') { // אם הפריט נשמר כ-ק"ג
                radioKg.checked = true;
            } else if (item.unitType === 'units') { // אם הפריט נשמר כ-יחידות
                radioUnits.checked = true;
            } else if (rules.defaultUnitType === 'kg' && rules.allowKg) { // ברירת מחדל קטגוריה: ק"ג
                radioKg.checked = true;
            } else { // ברירת מחדל קטגוריה: יחידות
                radioUnits.checked = true;
            }


            // הצג/הסתר כפתורי רדיו בהתאם לכללים
            if (rules.allowKg && !isMilk) { // אם ק"ג מותר וזה לא חלב
                quantityControlDiv.appendChild(radioKg);
                quantityControlDiv.appendChild(labelKg);
            } else {
                radioKg.style.display = 'none'; // הסתר את כפתור הרדיו ק"ג
                labelKg.style.display = 'none'; // הסתר את התווית ק"ג
            }
            
            if (rules.allowUnits) {
                quantityControlDiv.appendChild(radioUnits);
                quantityControlDiv.appendChild(labelUnits);
            } else {
                radioUnits.style.display = 'none'; // הסתר את כפתור הרדיו יחידות
                labelUnits.style.display = 'none'; // הסתר את התווית יחידות
            }

            // שדה קלט כמות
            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = item.quantity === 0 ? '' : item.quantity; // הצג ריק אם הכמות היא 0
            quantityInput.min = "0"; // יכול להיות 0
            quantityInput.step = "0.1";
            quantityInput.max = "99.9";
            quantityInput.setAttribute('onfocus', 'this.select()'); // סמן את התוכן בלחיצה

            quantityInput.oninput = (e) => {
                let value = e.target.value;
                // מנקה תווי מינוס או כל תו לא חוקי שלא מספר או נקודה
                value = value.replace(/[^0-9.]/g, ''); 
                
                // וודא שאין יותר מנקודה אחת
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                if (value.indexOf('.') !== -1) {
                    // אם יש נקודה, וודא שיש רק ספרה אחת אחרי הנקודה (כמו 1.5)
                    if (parts[1] && parts[1].length > 1) {
                        parts[1] = parts[1].slice(0, 1);
                        value = parts[0] + '.' + parts[1];
                    }
                    // מגביל ל-2 ספרות לפני הנקודה
                    if (parts[0].length > 2) {
                        parts[0] = parts[0].slice(0, 2);
                        value = parts[0] + (parts[1] ? '.' + parts[1] : '');
                    }
                } else {
                    // אם אין נקודה, מגביל ל-3 ספרות
                    if (value.length > 3) {
                        value = value.slice(0, 3);
                    }
                }
                e.target.value = value;
                updateItemData(item, 'quantity', parseFloat(value) || 0); // אם ריק, יוגדר כ-0
            };
            quantityInput.onblur = (e) => {
                const val = parseFloat(e.target.value);
                // אם השדה ריק או הערך לא חוקי, נגדיר אותו כ-0
                updateItemData(item, 'quantity', isNaN(val) ? 0 : val);
                // וודא שהשדה מציג 0 אם הערך הוא 0
                if (isNaN(val) || val === 0) {
                    e.target.value = '';
                }
            };
            quantityControlDiv.appendChild(quantityInput);

            // Listener for radio button changes
            const updateUnitTypeAndUnit = () => {
                if (radioKg.checked) {
                    updateItemData(item, 'unitType', 'kg');
                    updateItemData(item, 'unit', 'ק״ג');
                } else { // radioUnits.checked
                    updateItemData(item, 'unitType', 'units');
                    updateItemData(item, 'unit', 'יחידות');
                }
            };
            radioKg.addEventListener('change', updateUnitTypeAndUnit);
            radioUnits.addEventListener('change', updateUnitTypeAndUnit);
            
            // הפעל את updateUnitTypeAndUnit פעם אחת כדי להגדיר את המצב הראשוני
            updateUnitTypeAndUnit();

            productItemDiv.appendChild(quantityControlDiv);

            // תצוגת כמות ויחידה במצב רשימת קניות (סטטי)
            const quantityDisplaySpan = document.createElement('span');
            quantityDisplaySpan.className = 'quantity-display';
            productItemDiv.appendChild(quantityDisplaySpan);


            // כפתורי פעולה
            const itemActionsDiv = document.createElement('div');
            itemActionsDiv.className = 'item-actions';

            const selectBtn = document.createElement('button');
            selectBtn.className = 'select-btn';
            selectBtn.title = "בחר/בטל בחירה לרשימת קניות";
            selectBtn.textContent = '🛒';
            itemActionsDiv.appendChild(selectBtn);

            const purchasedToggleBtn = document.createElement('button');
            purchasedToggleBtn.className = 'purchased-toggle-btn';
            purchasedToggleBtn.title = "סמן/בטל סמן כנקנה";
            purchasedToggleBtn.textContent = '✔';
            itemActionsDiv.appendChild(purchasedToggleBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.title = "מחק פריט";
            deleteBtn.textContent = '✖';
            itemActionsDiv.appendChild(deleteBtn);

            productItemDiv.appendChild(itemActionsDiv);
            td.appendChild(productItemDiv);
            
            // עדכן תצוגת כמות ויחידה בעת יצירה
            updateQuantityDisplay(item, productItemDiv); 
            attachEventListeners(productItemDiv); // חבר את הליסנרים לפריט שנוצר
            return td;
        }

        // פונקציה לעדכון נתוני פריט במבנה הנתונים ושמירה
        function updateItemData(item, key, value) {
            item[key] = value;
            saveItems();
            // מצא את ה-productItemDiv המתאים ועדכן את התצוגה הסטטית
            // כדי למנוע יצירה מחדש של אלמנטים כל פעם, ננסה למצוא את האלמנט הקיים
            const productItemDiv = document.querySelector(`[data-category-table-id="${item.__categoryId}"][data-item="${item.name}"]`);
            if (productItemDiv) {
                updateQuantityDisplay(item, productItemDiv); 
            }
        }

        // פונקציה לרינדור המוצרים בדף
        let currentViewMode = 'all'; // 'all' or 'shopping-list'

        function renderItems(viewMode) {
            currentViewMode = viewMode;
            document.body.classList.toggle('shopping-list-mode', viewMode === 'shopping-list');

            // עדכן את כפתורי הווטסאפ: הסתר במצב "כל המוצרים" והצג במצב "רשימת קניות"
            const whatsappButtons = document.querySelectorAll('.whatsapp-button');
            whatsappButtons.forEach(btn => {
                btn.style.display = (viewMode === 'shopping-list') ? 'inline-block' : 'none';
            });
            const whatsappSettingsDiv = document.querySelector('.whatsapp-settings');
            whatsappSettingsDiv.style.display = (viewMode === 'shopping-list') ? 'flex' : 'none';


            for (const categoryId in currentItems) {
                const tableBody = document.getElementById(categoryId)?.querySelector('tbody');
                const categoryDiv = document.getElementById(categoryId.replace('-table', '-div'));
                
                if (!tableBody || !categoryDiv) continue; // וודא שהאלמנטים קיימים

                tableBody.innerHTML = ''; // נקה את התוכן הקיים
                let hasVisibleItemsInCategory = false;
                
                // צור מערך זמני כדי לטפל בעמודות
                let currentRow = document.createElement('tr');
                let itemsInRow = 0;

                currentItems[categoryId].forEach(item => {
                    // הוסף את ה-categoryId לפריט עצמו, זה יעזור ב-updateItemData
                    item.__categoryId = categoryId;

                    const shouldShowItem = 
                        (viewMode === 'all') || 
                        (viewMode === 'shopping-list' && item.selected && item.quantity > 0); 

                    if (shouldShowItem) {
                        const td = createProductTdElement(item, categoryId);
                        
                        // הוסף TD לשורה הנוכחית או צור שורה חדשה
                        if (itemsInRow === 2) { // אם יש כבר 2 פריטים בשורה
                            tableBody.appendChild(currentRow); // הוסף את השורה לטבלה
                            currentRow = document.createElement('tr'); // צור שורה חדשה
                            itemsInRow = 0;
                        }
                        currentRow.appendChild(td);
                        itemsInRow++;
                        hasVisibleItemsInCategory = true;
                    }
                });

                // הוסף את השורה האחרונה אם יש בה פריטים
                if (itemsInRow > 0) {
                    tableBody.appendChild(currentRow);
                }

                // הסתר קטגוריה אם אין בה פריטים במצב רשימת קניות
                if (viewMode === 'shopping-list') {
                    if (hasVisibleItemsInCategory) {
                        categoryDiv.classList.remove('category-hidden');
                    } else {
                        categoryDiv.classList.add('category-hidden');
                    }
                } else {
                    categoryDiv.classList.remove('category-hidden'); // תמיד הצג באל הכל
                }
            }
            updateActiveButtons(); // עדכן את מצב הכפתורים
        }


        // פונקציה לטיפול באירועים על פריט
        function attachEventListeners(productItemDiv) {
            const selectBtn = productItemDiv.querySelector('.select-btn');
            const deleteBtn = productItemDiv.querySelector('.delete-btn');
            const purchasedToggleBtn = productItemDiv.querySelector('.purchased-toggle-btn');
            
            const itemName = productItemDiv.getAttribute('data-item');
            const categoryTableId = productItemDiv.getAttribute('data-category-table-id');
            const item = currentItems[categoryTableId].find(i => i.name === itemName);

            if (!item) return; // לוודא שהפריט קיים

            // טיפול בלחיצה על כפתור בחירה (עגלה)
            if (selectBtn) { // וודא שהכפתור קיים
                selectBtn.onclick = () => {
                    item.selected = !item.selected;
                    // אם נבחר, וודא שהכמות היא לפחות 1 אם היא 0
                    if (item.selected && item.quantity === 0) {
                        item.quantity = 1;
                        // עדכן את שדה הכמות בממשק המשתמש באופן מיידי
                        const quantityInput = productItemDiv.querySelector('.quantity-control input[type="number"]');
                        if (quantityInput) {
                            quantityInput.value = item.quantity;
                        }
                    } else if (!item.selected && item.quantity > 0) {
                        // אם בוטלה הבחירה אבל יש כמות, השאר את הכמות
                        // או אפשרות: אם בוטלה הבחירה, נאפס כמות:
                        // item.quantity = 0; 
                        // const quantityInput = productItemDiv.querySelector('.quantity-control input[type="number"]');
                        // if (quantityInput) { quantityInput.value = ''; }
                    }
                    saveItems();
                    // תמיד לרנדר מחדש כדי להבטיח שהעיצוב והסינון נכונים
                    renderItems(currentViewMode); 
                };
            }

            // טיפול בלחיצה על כפתור קנייה (וי)
            if (purchasedToggleBtn) { // וודא שהכפתור קיים
                purchasedToggleBtn.onclick = () => {
                    item.purchased = !item.purchased;
                    saveItems();
                    // רק עדכן את הקלאס עבור הפריט הספציפי במצב רשימת קניות
                    if (currentViewMode === 'shopping-list') {
                        productItemDiv.classList.toggle('purchased', item.purchased);
                    } else {
                        // במצב "כל המוצרים", אם מישהו מנסה לסמן כנקנה (למרות שהכפתור מוסתר), 
                        // זה לא אמור להשפיע על המראה של הקו החוצה
                        // אבל כן נעדכן את המאפיין.
                    }
                };
            }

            // טיפול בלחיצה על כפתור מחיקה
            if (deleteBtn) { // וודא שהכפתור קיים
                deleteBtn.onclick = () => {
                    if (confirm(`האם אתה בטוח שברצונך למחוק את "${item.name}"?`)) {
                        currentItems[categoryTableId] = currentItems[categoryTableId].filter(i => i.name !== itemName);
                        saveItems();
                        renderItems(currentViewMode); // רנדר מחדש לאחר מחיקה
                    }
                };
            }
        }

        // פונקציה להוספת פריט חדש
        function addNewItem() {
            const newItemText = document.getElementById('new-item-text').value.trim();
            let newItemQuantity = parseFloat(document.getElementById('new-item-quantity-add').value);
            const categorySelect = document.getElementById('category-select');
            const categoryTableId = categorySelect.value;

            // אם הכמות ריקה או לא מספר תקין, הגדר אותה כ-0.
            if (isNaN(newItemQuantity) || newItemQuantity < 0) {
                newItemQuantity = 0;
            }

            if (!newItemText || !categoryTableId) {
                alert('אנא הזן שם פריט ובחר קטגוריה.');
                return;
            }

            if (!currentItems[categoryTableId]) {
                currentItems[categoryTableId] = [];
            }
            // וודא שהפריט לא קיים כבר באותה קטגוריה
            const existingItem = currentItems[categoryTableId].find(item => item.name === newItemText);
            if (existingItem) {
                alert(`הפריט "${newItemText}" כבר קיים בקטגוריה זו. ניתן לעדכן את הכמות שלו ישירות.`);
                return;
            }

            // קבלת כללי היחידות עבור הקטגוריה
            const rules = categoryUnitRules[categoryTableId] || { allowKg: true, allowUnits: true, defaultUnitType: "units" };
            
            let newItemUnitType;
            let newItemUnit;

            // טיפול מיוחד בשם הפריט בהוספה - אם זה "חלב דל לקטוז" בקטגוריית "מוצרי חלב"
            const isMilkAddMode = newItemText === "חלב דל לקטוז" && categoryTableId === "dairy-products-table";

            if (isMilkAddMode) {
                newItemUnitType = 'units';
                newItemUnit = 'יחידות';
            } else if (rules.allowKg && document.getElementById('add-unit-type-kg').checked) {
                newItemUnitType = 'kg';
                newItemUnit = 'ק״ג';
            } else { // ברירת מחדל או אם רק יחידות מותרות
                newItemUnitType = 'units';
                newItemUnit = 'יחידות';
            }


            const newItem = {
                name: newItemText,
                quantity: newItemQuantity,
                unit: newItemUnit,
                unitType: newItemUnitType,
                selected: false,
                purchased: false
            };
            currentItems[categoryTableId].push(newItem);
            saveItems();
            renderItems(currentViewMode); // רנדר מחדש את כל הפריטים כדי לוודא תצוגה נכונה
            
            // נקה שדות
            document.getElementById('new-item-text').value = '';
            document.getElementById('new-item-quantity-add').value = '0'; // אפס בחזרה ל-0
        }


        // פונקציה להוספת קטגוריה חדשה
        function addNewCategory() {
            const newCategoryName = document.getElementById('new-category-name').value.trim();
            if (newCategoryName) {
                // יצירת ID ייחודי לקטגוריה
                const categoryId = newCategoryName.toLowerCase().replace(/\s+/g, '-') + '-table';

                if (document.getElementById(categoryId)) {
                    alert('קטגוריה בשם זה כבר קיימת!');
                    return;
                }

                // הוספת ה-div וה-table ל-DOM
                const containerDiv = document.querySelector('.container');
                const newCategoryDiv = document.createElement('div');
                newCategoryDiv.id = categoryId.replace('-table', '-div');
                newCategoryDiv.innerHTML = `
                    <h2>${newCategoryName}</h2>
                    <table id="${categoryId}"><tbody></tbody></table>
                `;
                // הוסף לפני סעיף הוספת פריט או קטגוריה
                // ננסה להוסיף לפני ה-add-new-item-section הראשון
                const firstAddNewItemSection = document.querySelector('.add-new-item-section');
                if (firstAddNewItemSection) {
                    containerDiv.insertBefore(newCategoryDiv, firstAddNewItemSection);
                } else {
                    containerDiv.appendChild(newCategoryDiv); // fallback אם אין סעיפי הוספה
                }

                // הוסף את הקטגוריה החדשה למבנה הנתונים
                currentItems[categoryId] = [];
                categoryMap[categoryId] = newCategoryName; // עדכן את ה-map

                // הוסף כללי יחידות ברירת מחדל לקטגוריה החדשה
                categoryUnitRules[categoryId] = { allowKg: true, allowUnits: true, defaultUnitType: "units" };


                saveItems();
                populateCategorySelect(); // עדכן את רשימת הקטגוריות ב-select
                document.getElementById('new-category-name').value = ''; // נקה שדה
                renderItems(currentViewMode); // רנדר מחדש כדי לוודא שהקטגוריה הריקה מופיעה (אם במצב "הכל")
            } else {
                alert('אנא הזן שם לקטגוריה החדשה.');
            }
        }


        // פונקציה למילוי ה-select של הקטגוריות
        function populateCategorySelect() {
            const categorySelect = document.getElementById('category-select');
            categorySelect.innerHTML = ''; // נקה אפשרויות קודמות

            // הפוך את ה-categoryMap למערך, מיין לפי שמות קטגוריות
            const sortedCategories = Object.keys(categoryMap).map(id => ({ id, name: categoryMap[id] }))
                                    .sort((a, b) => a.name.localeCompare(b.name, 'he'));

            sortedCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });

            // הפעל את עדכון ה-UI של יחידות ההוספה כברירת מחדל עבור הקטגוריה שנבחרה ראשונה
            updateAddItemUnitUI();
        }


        // פונקציה לעדכון ה-UI של כפתורי הרדיו ב"הוסף פריט חדש"
        function updateAddItemUnitUI() {
            const categorySelect = document.getElementById('category-select');
            const selectedCategoryTableId = categorySelect.value;
            const rules = categoryUnitRules[selectedCategoryTableId] || { allowKg: true, allowUnits: true, defaultUnitType: "units" };

            const addUnitTypeKgRadio = document.getElementById('add-unit-type-kg');
            const labelKg = document.querySelector('label[for="add-unit-type-kg"]');
            const addUnitTypeUnitsRadio = document.getElementById('add-unit-type-units');
            const labelUnits = document.querySelector('label[for="add-unit-type-units"]');

            // טיפול מיוחד בשם הפריט בהוספה - אם זה "חלב דל לקטוז" בקטגוריית "מוצרי חלב"
            const newItemText = document.getElementById('new-item-text').value.trim();
            const isMilkAddMode = newItemText === "חלב דל לקטוז" && selectedCategoryTableId === "dairy-products-table";

            if (isMilkAddMode) {
                // הסתר ק"ג, הצג יחידות, וסמן יחידות
                addUnitTypeKgRadio.style.display = 'none';
                labelKg.style.display = 'none';
                addUnitTypeUnitsRadio.style.display = 'inline-block';
                labelUnits.style.display = 'inline-block';
                addUnitTypeUnitsRadio.checked = true;
            } else {
                // הצג/הסתר כפתורי רדיו לפי כללי הקטגוריה
                addUnitTypeKgRadio.style.display = rules.allowKg ? 'inline-block' : 'none';
                labelKg.style.display = rules.allowKg ? 'inline-block' : 'none';
                addUnitTypeUnitsRadio.style.display = rules.allowUnits ? 'inline-block' : 'none';
                labelUnits.style.display = rules.allowUnits ? 'inline-block' : 'none';

                // בחר את כפתור הרדיו הנכון כברירת מחדל
                if (rules.allowKg && rules.defaultUnitType === "kg") {
                    addUnitTypeKgRadio.checked = true;
                } else if (rules.allowUnits && rules.defaultUnitType === "units") {
                    addUnitTypeUnitsRadio.checked = true;
                } else if (rules.allowKg) { // fallback if default not set or allowed and kg is available
                    addUnitTypeKgRadio.checked = true;
                } else if (rules.allowUnits) { // fallback if only units is available
                    addUnitTypeUnitsRadio.checked = true;
                }
            }
        }

        // עדכון מצב הכפתורים הראשיים
        function updateActiveButtons() {
            document.getElementById('show-all-btn').classList.toggle('active-mode', currentViewMode === 'all');
            document.getElementById('show-shopping-list-btn').classList.toggle('active-mode', currentViewMode === 'shopping-list');
        }

        // פונקציה לייצוא רשימת קניות לוואטסאפ
        function exportToWhatsApp() {
            let message = "רשימת הקניות שלי:\n\n";
            let hasSelectedItems = false;
            let itemsByCategory = {}; // נשתמש באובייקט כדי לקבץ פריטים לפי קטגוריה

            // עבור על כל הקטגוריות והפריטים
            for (const categoryId in currentItems) {
                // אסוף פריטים שסומנו לעגלה ויש להם כמות גדולה מ-0
                currentItems[categoryId].forEach(item => {
                    if (item.selected && item.quantity > 0) {
                        const categoryName = categoryMap[categoryId] || categoryId.replace('-table', '');
                        if (!itemsByCategory[categoryName]) {
                            itemsByCategory[categoryName] = [];
                        }
                        itemsByCategory[categoryName].push(`${item.name}: ${item.quantity} ${item.unit}`);
                        hasSelectedItems = true;
                    }
                });
            }

            if (!hasSelectedItems) {
                alert('לא נבחרו פריטים לרשימת הקניות. אנא בחר פריטים בעזרת כפתור "🛒"');
                return;
            }

            // בנה את ההודעה המעוצבת מתוך ה-itemsByCategory
            for (const categoryName in itemsByCategory) {
                message += `*${categoryName}:*\n`;
                itemsByCategory[categoryName].forEach(itemText => {
                    message += `  - ${itemText}\n`;
                });
                message += "\n"; // רווח בין קטגוריות
            }

            // נקה רווחים מיותרים בסוף ההודעה
            message = message.trim();

            // קבלת מספרי הטלפון משדה הקלט
            const numbersInput = document.getElementById('whatsapp-numbers').value.trim();
            let phoneNumbers = numbersInput.split(',').map(num => num.trim()).filter(num => num !== '');

            // וודא שמספרי הטלפון תקינים ומתחילים ב-972 (או תוספת +)
            phoneNumbers = phoneNumbers.map(num => {
                if (num.startsWith('05')) {
                    return '972' + num.substring(1); // ממיר 05xxxxxx ל-9725xxxxxx
                }
                if (num.startsWith('+972')) {
                    return num.substring(1); // מסיר + מ-+972xxxxxx
                }
                return num; // משאיר מספרים אחרים כמו שהם (אם כבר בפורמט בינלאומי)
            });

            const encodedMessage = encodeURIComponent(message);
            
            // בנה את הקישור בהתאם למספרים
            // שימוש ב-wa.me/?text=... כדי לאפשר למשתמש לבחור נמען, שזו הדרך האמינה ביותר למספרים מרובים
            const whatsappLink = `https://wa.me/?text=${encodedMessage}`;
            
            window.open(whatsappLink, '_blank');
        }


        // איתחול הדף
        document.addEventListener('DOMContentLoaded', () => {
            currentItems = loadItems(); // טען נתונים מ-localStorage
            populateCategorySelect(); // מלא את רשימת הקטגוריות
            renderItems('all'); // הצג את כל המוצרים כברירת מחדל
            
            document.getElementById('show-all-btn').addEventListener('click', () => renderItems('all'));
            document.getElementById('show-shopping-list-btn').addEventListener('click', () => renderItems('shopping-list'));

            // לוגיקה לבחירת סוג יחידה (ק"ג/יחידות) בהוספת פריט חדש
            document.getElementById('category-select').addEventListener('change', updateAddItemUnitUI);
            document.getElementById('add-unit-type-kg').addEventListener('change', updateAddItemUnitUI);
            document.getElementById('add-unit-type-units').addEventListener('change', updateAddItemUnitUI);
            document.getElementById('new-item-text').addEventListener('input', updateAddItemUnitUI); // עדכן כשמקלידים שם פריט (לצורך "חלב")
        });

    </script>
</body>
</html>